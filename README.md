# JH BMS ESP32 Component for ESPHome

这是一个为ESPHome设计的JH BMS (JBD智能电池管理系统) BLE通信组件。该组件允许ESP32通过蓝牙低功耗(BLE)与JH系列BMS进行通信，读取电池状态数据并控制某些功能。

## 特性

### 数据读取
- 电池单体电压（最多32个）
- 总电压、电流、功率
- 荷电状态(SOC)
- 剩余容量
- 充电循环次数
- 温度传感器数据
- 最小/最大/平均/电压差单体电压
- 设备信息（型号、固件版本等）
- 错误信息和操作状态

### 状态监控
- 在线状态
- 充电状态
- 放电状态
- 均衡状态
- 加热状态
- 干接点状态

### 控制功能
- 充电开关
- 放电开关
- 均衡器开关
- 加热开关
- 电压保护阈值设置
- 均衡触发电压设置
- 清除错误
- 检索和保存设置

## 支持的协议版本
- JH01
- JH02 (默认)
- JH03

## 配置指南

### 基本配置

```yaml
# 启用BLE追踪器
esp32_ble_tracker:
  scan_parameters:
    interval: 1100ms
    window: 1100ms
    active: true

# JH BMS ESP32组件配置
jh_bms_esp32:
  protocol_version: JH02  # 可选: JH01, JH02, JH03
  throttle: 10s  # 数据轮询间隔
  ble_client_id: bms_client

# BLE客户端配置
ble_client:
  - mac_address: "XX:XX:XX:XX:XX:XX"  # 替换为您的JH BMS设备的MAC地址
    id: bms_client
    auto_reconnect: true
```

### 完整配置示例

请参考[esp32-ble-jh-bms-example.yaml](../esp32-ble-jh-bms-example.yaml)文件获取完整的配置示例。

## 参数说明

### JH BMS组件参数
- `protocol_version`: JH BMS使用的协议版本（JH01、JH02或JH03）
- `throttle`: 数据轮询间隔，默认为10秒
- `ble_client_id`: 要使用的BLE客户端ID

### 传感器配置
组件支持多种传感器类型，包括数值传感器、二进制传感器和文本传感器。每种传感器都可以通过指定的配置项启用。

## 使用注意事项

1. **MAC地址配置**
   - 请确保正确配置BMS设备的MAC地址，否则无法建立连接。

2. **协议版本选择**
   - 请根据您的BMS型号选择正确的协议版本。如果不确定，可以尝试不同的版本。

3. **连接稳定性**
   - BLE连接可能受距离和干扰影响。请确保ESP32与BMS之间的距离不要太远，并减少周围的无线干扰。

4. **电池数量配置**
   - 根据您实际的电池组配置，只启用所需数量的单体电压传感器，以减少不必要的资源消耗。

5. **固件兼容性**
   - 不同的BMS固件版本可能会有略微不同的数据结构，可能需要根据实际情况调整组件配置。

## 调试信息

如果遇到问题，可以启用ESPHome的调试日志来查看详细的通信过程：

```yaml
logger:
  level: DEBUG
```

## 开发说明

本组件是基于JK BMS组件的实现进行修改的。由于JH BMS的协议可能与JK BMS有所不同，因此在使用前可能需要根据实际的协议分析结果进行调整。

主要需要注意的修改点：
- 帧头和命令码定义
- CRC校验算法
- 数据帧解析逻辑
- 寄存器写入命令格式

## 免责声明

使用此组件时，请确保您了解BMS的基本工作原理和安全操作规范。不当的配置或操作可能会导致电池损坏或其他安全问题。请在使用前仔细阅读BMS的用户手册。

## 支持与贡献

如果您在使用过程中发现任何问题或有改进建议，请提交Issue或Pull Request。